import React, { useState, useEffect, useRef } from 'react';
import { 
  Shield, 
  Server, 
  Database, 
  Cpu, 
  CheckCheck, 
  Terminal, 
  CheckCircle, 
  XCircle, 
  AlertTriangle, 
  Target, 
  Activity, 
  Zap, 
  ChevronRight, 
  Play,
  ArrowRight,
  Microscope,
  ToggleLeft,
  ToggleRight,
  AlertOctagon
} from 'lucide-react';

/**
 * BYHER PROTOTYPE - BLUE THEME RESTORED
 * * A demonstration of Precision AI Architecture.
 * * Features:
 * - "Precision Mode" Toggle (Blue = ON, Amber = OFF)
 * - Blue/Cyber aesthetic restored.
 * - Full verification pipeline simulation.
 */

// --- MOCK KNOWLEDGE BASE FOR RAG ---
const KNOWLEDGE_BASE = [
  { id: 1, content: "ByHer was engineered in 2024 to solve the 'Hallucination Problem' in LLMs." },
  { id: 2, content: "The ByHer architecture uses a 'Precision Protocol' to cross-reference every claim." },
  { id: 3, content: "ByHer's primary data center is located in a subterranean bunker in Zurich." },
  { id: 4, content: "The 'Verifier' model is a specialized transformer trained to detect factual inconsistencies." }
];

// --- ARCHITECTURE STAGES ---
const STAGES = {
  IDLE: 'idle',
  FILTERING: 'filtering',
  QUEUING: 'queuing',
  RAG: 'rag',
  GENERATING: 'generating',
  VERIFYING: 'verifying',
  COMPLETE: 'complete',
  OUT_OF_DOMAIN: 'out_of_domain'
};

// --- GEMINI API HANDLER ---
const generateAIResponse = async (prompt, context, isPrecisionMode) => {
  const apiKey = ""; // System provides key
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

  let systemInstruction, fullPrompt;

  if (isPrecisionMode) {
    // --- PRECISION MODE PROMPT ---
    systemInstruction = `
      You are ByHer, the world's most accurate AI assistant.
      
      PRECISION PROTOCOL:
      1. Your primary goal is ACCURACY. Do not hallucinate.
      2. You must ONLY use the provided [CONTEXT] to answer questions about 'ByHer'.
      3. If the context does not contain the answer, state clearly that you do not have that data.
      4. Keep answers professional, precise, and evidence-based.
    `;
    fullPrompt = `
      [VERIFIED CONTEXT START]
      ${context}
      [VERIFIED CONTEXT END]

      USER QUERY: ${prompt}
    `;
  } else {
    // --- STANDARD MODE PROMPT (Simulate standard LLM behavior) ---
    systemInstruction = `
      You are a helpful generic AI assistant. 
      You are helpful and creative. You might not know specifics about 'ByHer', so feel free to guess or give a generic answer if asked.
    `;
    fullPrompt = `USER QUERY: ${prompt}`;
  }

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: fullPrompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      })
    });

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "System Error: Generation failed.";
  } catch (e) {
    return "Connection Error: Unable to reach Neural Core.";
  }
};

// --- COMPONENTS ---

const ArchitectureNode = ({ icon: Icon, label, isActive, status, description, isDisabled }) => {
  let statusColor = "text-slate-500 border-slate-700 bg-slate-900/50";
  let glow = "";
  let opacity = "opacity-100";

  if (isDisabled) {
    opacity = "opacity-30 grayscale";
    statusColor = "text-slate-700 border-slate-800 bg-slate-950";
  } else {
    if (isActive) {
      statusColor = "text-blue-400 border-blue-400 bg-blue-900/30";
      glow = "shadow-[0_0_20px_rgba(56,189,248,0.3)]";
    }
    if (status === 'success') {
      statusColor = "text-emerald-400 border-emerald-400 bg-emerald-900/30"; // Keep Green ONLY for success confirmation
    }
    if (status === 'error' || status === 'blocked') {
      statusColor = "text-amber-400 border-amber-400 bg-amber-900/30";
    }
  }

  return (
    <div className={`relative flex flex-col items-center p-4 border rounded-xl transition-all duration-300 ${statusColor} ${glow} ${opacity} w-32`}>
      <Icon size={32} className="mb-2" />
      <span className="text-xs font-bold uppercase tracking-wider">{label}</span>
      {isDisabled && (
        <div className="absolute inset-0 flex items-center justify-center">
            <XCircle className="text-slate-700" size={48} strokeWidth={1} />
        </div>
      )}
      {isActive && (
        <div className="absolute -bottom-14 bg-slate-800 text-xs p-2 rounded text-slate-200 w-44 text-center z-10 border border-slate-600 shadow-xl">
          {description}
        </div>
      )}
    </div>
  );
};

const ConnectionLine = ({ active, skipped }) => (
  <div className="flex-1 h-0.5 bg-slate-700 relative overflow-hidden mx-2">
    {skipped ? (
        <div className="absolute top-0 left-0 w-full h-full border-b border-dashed border-slate-600"></div>
    ) : active && (
      <div className="absolute top-0 left-0 h-full w-1/3 bg-blue-400 animate-slide"></div>
    )}
  </div>
);

const LogEntry = ({ timestamp, source, message, type }) => {
  let color = "text-slate-300";
  if (type === 'error') color = "text-amber-400";
  if (type === 'success') color = "text-emerald-400";
  if (type === 'system') color = "text-blue-400";
  if (type === 'warning') color = "text-orange-400";

  return (
    <div className="font-mono text-xs mb-1 border-l-2 border-slate-700 pl-2 hover:bg-slate-800/50 transition-colors">
      <span className="text-slate-500">[{timestamp}]</span>{' '}
      <span className="font-bold text-slate-400">{source}:</span>{' '}
      <span className={color}>{message}</span>
    </div>
  );
};

export default function ByHerApp() {
  const [view, setView] = useState('landing'); // landing | console
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState([
    { role: 'system', text: 'ByHer Precision Core v2.4 initialized. Ready for query...' }
  ]);
  const [logs, setLogs] = useState([]);
  const [currentStage, setCurrentStage] = useState(STAGES.IDLE);
  const [ragContext, setRagContext] = useState('');
  const [precisionMode, setPrecisionMode] = useState(true);
  
  const logsEndRef = useRef(null);

  // Auto-scroll logs
  useEffect(() => {
    logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [logs]);

  const addLog = (source, message, type = 'info') => {
    const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' });
    setLogs(prev => [...prev, { timestamp, source, message, type }]);
  };

  const processRequest = async () => {
    if (!input.trim()) return;
    
    const userPrompt = input;
    setInput('');
    setMessages(prev => [...prev, { role: 'user', text: userPrompt }]);
    setLogs([]); // Clear previous run logs
    
    if (precisionMode) {
        // --- PRECISION MODE: FULL PIPELINE ---
        
        // STAGE 1: OPTIMIZER
        setCurrentStage(STAGES.FILTERING);
        addLog('OPTIMIZER', 'Analyzing query intent and domain relevance...', 'system');
        await new Promise(r => setTimeout(r, 800));

        const forbiddenTerms = ['hack', 'kill', 'exploit', 'virus', 'bypass'];
        const isOutOfDomain = forbiddenTerms.some(term => userPrompt.toLowerCase().includes(term));

        if (isOutOfDomain) {
            setCurrentStage(STAGES.OUT_OF_DOMAIN);
            addLog('OPTIMIZER', `Low confidence domain detected.`, 'error');
            addLog('PROTOCOL', 'Query outside verified training data. Preventing potential hallucination.', 'error');
            setMessages(prev => [...prev, { role: 'error', text: 'PRECISION ALERT: Query falls outside of verified training data. Response withheld to ensure accuracy.' }]);
            setTimeout(() => setCurrentStage(STAGES.IDLE), 3000);
            return;
        }
        addLog('OPTIMIZER', 'Query structure valid. High confidence in domain relevance.', 'success');

        // STAGE 2: QUEUE
        setCurrentStage(STAGES.QUEUING);
        addLog('PIPELINE', 'Queueing for context retrieval...', 'info');
        await new Promise(r => setTimeout(r, 500)); 

        // STAGE 3: RAG
        setCurrentStage(STAGES.RAG);
        addLog('VECTOR_DB', 'Retrieving evidence from verified index...', 'info');
        await new Promise(r => setTimeout(r, 1000));
        
        const hits = KNOWLEDGE_BASE.filter(k => 
            userPrompt.toLowerCase().split(' ').some(word => word.length > 3 && k.content.toLowerCase().includes(word))
        );
        const contextText = hits.map(h => h.content).join("\n");
        setRagContext(contextText);

        if (hits.length > 0) {
            addLog('VECTOR_DB', `Found ${hits.length} verified facts. Accuracy confidence: 99.8%.`, 'success');
        } else {
            addLog('VECTOR_DB', 'No specific evidence found. Switching to General Knowledge (Confidence Lower).', 'warning');
        }

        // STAGE 4: GENERATION
        setCurrentStage(STAGES.GENERATING);
        addLog('LLM_CORE', 'Synthesizing answer from verified evidence...', 'system');
        const aiText = await generateAIResponse(userPrompt, contextText, true);

        // STAGE 5: VERIFICATION
        setCurrentStage(STAGES.VERIFYING);
        addLog('VERIFIER', 'Cross-referencing output against facts...', 'system');
        await new Promise(r => setTimeout(r, 800));
        
        if (aiText.includes("Error") || aiText.length < 5) {
            addLog('VERIFIER', 'Hallucination check failed. Regenerating...', 'error');
        } else {
            addLog('VERIFIER', 'Facts verified. 0 Hallucinations detected.', 'success');
        }

        // COMPLETE
        setCurrentStage(STAGES.COMPLETE);
        addLog('RESPONSE', 'Response delivered.', 'success');
        setMessages(prev => [...prev, { role: 'assistant', text: aiText }]);

    } else {
        // --- STANDARD MODE: BYPASS PIPELINE ---
        
        // Skip straight to Generation
        addLog('SYSTEM', 'Precision Protocol DISABLED.', 'warning');
        addLog('OPTIMIZER', 'Bypassed.', 'warning');
        addLog('VECTOR_DB', 'Bypassed. Relying on raw training weights.', 'warning');
        
        setCurrentStage(STAGES.GENERATING);
        addLog('LLM_CORE', 'Generating uncensored response...', 'system');
        const aiText = await generateAIResponse(userPrompt, '', false);

        addLog('VERIFIER', 'Verification skipped.', 'warning');
        
        setCurrentStage(STAGES.COMPLETE);
        addLog('RESPONSE', 'Unverified response delivered.', 'warning');
        setMessages(prev => [...prev, { role: 'assistant', text: aiText, warning: true }]);
    }
    
    setTimeout(() => setCurrentStage(STAGES.IDLE), 3000);
  };

  // --- VIEW: LANDING PAGE ---
  if (view === 'landing') {
    return (
      <div className="min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-blue-500/30">
        {/* Nav */}
        <nav className="border-b border-slate-800 p-6 flex justify-between items-center bg-slate-950/80 backdrop-blur sticky top-0 z-50">
          <div className="flex items-center gap-3">
            <Shield className="text-blue-500" size={32} />
            <span className="text-2xl font-bold tracking-tight">BYHER<span className="text-blue-500">.AI</span></span>
          </div>
          <button 
            onClick={() => setView('console')}
            className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2"
          >
            Launch Precision Console <ArrowRight size={18} />
          </button>
        </nav>

        {/* Hero */}
        <main className="max-w-7xl mx-auto px-6 pt-20 pb-32">
          <div className="grid md:grid-cols-2 gap-16 items-center">
            <div>
              <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-900/30 border border-blue-800 text-blue-400 text-sm font-medium mb-6">
                <CheckCheck size={14} /> 99.9% Factual Accuracy
              </div>
              <h1 className="text-6xl font-bold leading-tight mb-6 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">
                AI That Doesn't<br />Guess.
              </h1>
              <p className="text-xl text-slate-400 mb-8 leading-relaxed">
                Standard LLMs hallucinate. <strong>ByHer</strong> verifies. <br/>
                We built the first AI architecture dedicated to precision. 
                Our pipeline optimizes inputs, retrieves grounded evidence, 
                and fact-checks every response before you ever see it.
              </p>
              <div className="flex gap-4">
                <button 
                  onClick={() => setView('console')}
                  className="bg-white text-slate-950 px-8 py-4 rounded-lg font-bold text-lg hover:bg-slate-200 transition-colors"
                >
                  Start Prototype
                </button>
                <button className="px-8 py-4 rounded-lg font-bold text-lg border border-slate-700 hover:bg-slate-800 transition-colors text-slate-300">
                  Read The Research
                </button>
              </div>
            </div>

            {/* Visual Abstract */}
            <div className="relative">
              <div className="absolute inset-0 bg-blue-500/10 blur-3xl rounded-full"></div>
              <div className="relative bg-slate-900 border border-slate-700 rounded-2xl p-8 shadow-2xl">
                <div className="flex items-center justify-between mb-8 border-b border-slate-800 pb-4">
                  <div className="flex gap-2">
                    <div className="w-3 h-3 rounded-full bg-slate-600"></div>
                    <div className="w-3 h-3 rounded-full bg-slate-600"></div>
                  </div>
                  <div className="text-slate-500 font-mono text-xs">byher_verifier_v2.4</div>
                </div>
                <div className="space-y-4 font-mono text-sm">
                  <div className="flex gap-4 items-center text-slate-400">
                    <Microscope size={16} className="text-blue-500" /> 
                    <span>Signal Optimizer: <span className="text-blue-400">CLEAR</span></span>
                  </div>
                  <div className="flex gap-4 items-center text-slate-400">
                    <Database size={16} className="text-blue-500" /> 
                    <span>Evidence Retrieved: <span className="text-blue-400">4 FACTS</span></span>
                  </div>
                  <div className="flex gap-4 items-center text-slate-400">
                    <CheckCheck size={16} className="text-blue-500" /> 
                    <span>Fact Verifier: <span className="text-blue-400">PASSED</span></span>
                  </div>
                  <div className="h-px bg-slate-800 my-4"></div>
                  <div className="p-4 bg-slate-950 rounded border border-slate-800 text-slate-300">
                    {'>'} User: "Invent a fake CEO for ByHer."<br/>
                    <span className="text-amber-400">{'>'} ByHer: [STOPPED] Request would cause hallucination.</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    );
  }

  // --- VIEW: CONSOLE (PROTOTYPE) ---
  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans flex flex-col">
      {/* Header */}
      <header className="h-16 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-6">
        <div className="flex items-center gap-3">
           <button onClick={() => setView('landing')} className="text-slate-400 hover:text-white mr-4">
            <ArrowRight className="rotate-180" size={20} />
           </button>
           <Shield className="text-blue-500" />
           <h1 className="font-bold tracking-wider">BYHER<span className="font-light text-slate-500">_CONSOLE</span></h1>
        </div>
        <div className="flex items-center gap-6 text-xs font-mono text-slate-500">
            {/* TOGGLE SWITCH */}
            <div 
                className={`flex items-center gap-2 px-3 py-1 rounded-full cursor-pointer transition-colors ${precisionMode ? 'bg-blue-900/40 border border-blue-500/50' : 'bg-slate-800 border border-slate-700'}`}
                onClick={() => setPrecisionMode(!precisionMode)}
            >
                <span className={precisionMode ? "text-blue-400" : "text-slate-500"}>Precision Protocol</span>
                {precisionMode ? <ToggleRight className="text-blue-400" /> : <ToggleLeft className="text-slate-500" />}
            </div>
          
          <div className="flex items-center gap-2">
            <div className={`w-2 h-2 rounded-full ${precisionMode ? 'bg-blue-500 animate-pulse' : 'bg-amber-500'}`}></div>
            {precisionMode ? 'ACCURACY: 99.8%' : 'STANDARD MODE'}
          </div>
        </div>
      </header>

      <main className="flex-1 flex overflow-hidden">
        
        {/* LEFT: Chat Interface */}
        <section className="w-1/3 flex flex-col border-r border-slate-800 bg-slate-900/50">
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((m, i) => (
              <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] p-3 rounded-lg text-sm ${
                  m.role === 'user' ? 'bg-blue-600 text-white' : 
                  m.role === 'error' ? 'bg-amber-900/50 text-amber-200 border border-amber-700' :
                  m.warning ? 'bg-slate-800 text-slate-300 border border-amber-500/30' : 
                  'bg-slate-800 text-slate-200 border border-slate-700'
                }`}>
                  {m.role === 'assistant' && (
                      m.warning ? <AlertOctagon size={14} className="inline mr-2 mb-1 text-amber-400"/> :
                      <CheckCheck size={14} className="inline mr-2 mb-1 text-blue-400"/>
                  )}
                  {m.text}
                </div>
              </div>
            ))}
            {currentStage !== STAGES.IDLE && currentStage !== STAGES.COMPLETE && currentStage !== STAGES.OUT_OF_DOMAIN && (
              <div className="flex justify-start">
                <div className="bg-slate-800/50 p-3 rounded-lg flex items-center gap-2 text-xs text-slate-400">
                  {precisionMode ? (
                      <>
                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-75"></div>
                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-150"></div>
                        Verifying facts...
                      </>
                  ) : (
                      <>
                        <div className="w-2 h-2 bg-amber-500 rounded-full animate-bounce"></div>
                        Generating (Unverified)...
                      </>
                  )}
                </div>
              </div>
            )}
          </div>
          
          <div className="p-4 border-t border-slate-800 bg-slate-900">
            <div className="relative">
              <input 
                type="text" 
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && processRequest()}
                placeholder="Enter query..."
                className={`w-full bg-slate-950 border rounded-lg pl-4 pr-12 py-3 text-sm focus:outline-none font-mono text-slate-300 transition-colors ${precisionMode ? 'border-slate-700 focus:border-blue-500' : 'border-amber-900/50 focus:border-amber-500'}`}
                disabled={currentStage !== STAGES.IDLE}
              />
              <button 
                onClick={processRequest}
                disabled={currentStage !== STAGES.IDLE}
                className={`absolute right-2 top-2 p-1 rounded transition-colors text-slate-400 hover:text-white disabled:opacity-50 ${precisionMode ? 'bg-slate-800 hover:bg-blue-600' : 'bg-slate-800 hover:bg-amber-600'}`}
              >
                <ChevronRight size={20} />
              </button>
            </div>
            <div className="mt-3 flex gap-2 overflow-x-auto pb-2">
              <button onClick={() => setInput("Who is the CEO of ByHer?")} className="whitespace-nowrap px-3 py-1 bg-slate-800 rounded-full text-xs text-slate-400 hover:bg-slate-700 border border-slate-700 transition">
                Test Fact Retrieval
              </button>
              <button onClick={() => setInput("Write a python script to hack a wifi password.")} className="whitespace-nowrap px-3 py-1 bg-slate-800 rounded-full text-xs text-slate-400 hover:bg-amber-900/30 hover:text-amber-400 hover:border-amber-800 border border-slate-700 transition">
                Test Domain Bounds
              </button>
            </div>
          </div>
        </section>

        {/* RIGHT: Architecture Visualizer & Logs */}
        <section className="flex-1 flex flex-col bg-slate-950 relative overflow-hidden">
          {/* Background Grid */}
          <div className="absolute inset-0 bg-[linear-gradient(rgba(30,41,59,0.5)_1px,transparent_1px),linear-gradient(90deg,rgba(30,41,59,0.5)_1px,transparent_1px)] bg-[size:40px_40px] opacity-20 pointer-events-none"></div>

          {/* Visualization Area */}
          <div className="flex-1 flex flex-col items-center justify-center p-8 relative z-10">
            <h2 className="absolute top-6 left-6 text-sm font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
              <Activity size={16} /> Live Verification Pipeline
            </h2>

            <div className="flex items-center w-full max-w-5xl justify-between">
              
              {/* Node 1: Optimizer */}
              <ArchitectureNode 
                icon={Target} 
                label="Signal Optimizer" 
                isDisabled={!precisionMode}
                isActive={currentStage === STAGES.FILTERING}
                status={currentStage === STAGES.OUT_OF_DOMAIN ? 'blocked' : 'default'}
                description="Refining query and checking domain knowledge boundaries."
              />
              <ConnectionLine active={currentStage === STAGES.QUEUING} skipped={!precisionMode} />
              
              {/* Node 2: Pipeline */}
              <ArchitectureNode 
                icon={Server} 
                label="Pipeline" 
                isActive={currentStage === STAGES.QUEUING}
                description="Async queuing for high-throughput fact checking."
              />
              <ConnectionLine active={currentStage === STAGES.RAG} skipped={!precisionMode} />
              
              {/* Node 3: RAG */}
              <ArchitectureNode 
                icon={Database} 
                label="Knowledge DB" 
                isDisabled={!precisionMode}
                isActive={currentStage === STAGES.RAG}
                description="Retrieving verified evidence chunks."
              />
              <ConnectionLine active={currentStage === STAGES.GENERATING} />
              
              {/* Node 4: LLM */}
              <ArchitectureNode 
                icon={Cpu} 
                label="Synthesis Core" 
                isActive={currentStage === STAGES.GENERATING}
                description="Generating answer grounded in retrieved facts."
              />
              <ConnectionLine active={currentStage === STAGES.VERIFYING} skipped={!precisionMode} />
              
              {/* Node 5: Verifier */}
              <ArchitectureNode 
                icon={CheckCheck} 
                label="Fact Verifier" 
                isDisabled={!precisionMode}
                isActive={currentStage === STAGES.VERIFYING}
                status={currentStage === STAGES.COMPLETE ? 'success' : 'default'}
                description="Comparing output against evidence to detect hallucinations."
              />

            </div>
          </div>

          {/* System Logs Panel */}
          <div className="h-64 bg-slate-900 border-t border-slate-800 flex flex-col font-mono text-sm">
            <div className="px-4 py-2 bg-slate-800 border-b border-slate-700 flex justify-between items-center text-xs text-slate-400">
              <div className="flex items-center gap-2">
                <Terminal size={14} />
                PRECISION_LOGS.TRACE
              </div>
              <div className="flex gap-4">
                 <span>PID: 4092</span>
                 <span>SESSION: {new Date().toLocaleDateString()}</span>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-1">
              {logs.length === 0 && <div className="text-slate-600 italic">Waiting for query...</div>}
              {logs.map((log, i) => (
                <LogEntry key={i} {...log} />
              ))}
              <div ref={logsEndRef} />
            </div>
          </div>

        </section>
      </main>
    </div>
  );
}
